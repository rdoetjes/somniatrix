<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Somniatrix Horror Nightmare Terminal</title>
        <style>
            @font-face {
                font-family: "WebPlus_IBM_EGA_9x8";
                src: url("./WebPlus_IBM_EGA_9x8.woff") format("woff");
                font-weight: normal;
                font-style: normal;
                line-height: 20px; /* or 18px for 2px spacing */
            }
            #sceneMenu {
                position: absolute;
                top: 5%;
                left: 5%;
                width: 50%;
                height: 50%;
                background-color: rgba(0, 0, 0, 0.95);
                border: 1px solid #33ff33;
                padding: 1rem;
                overflow-y: auto;
                z-index: 10;
            }

            #sceneMenu button {
                margin: 0.25rem 0;
            }

            #crt {
                width: 80vw; /* 80% of the viewport width */
                height: 73vh; /* 90% of the viewport height */
                margin: 5vh auto; /* 5% vertical margin (5% top and bottom) */
                padding: 30px;
                background: radial-gradient(
                    ellipse at center,
                    rgba(0, 0, 0, 0) 50%,
                    rgba(0, 0, 0, 0.25) 100%
                );
                color: #33ff33;
                font-family: "WebPlus_IBM_EGA_9x8", monospace;
                font-size: 10px;
                line-height: 18px;
                border-radius: 30px;
                box-shadow:
                    inset 0 0 40px rgba(0, 255, 0, 0.2),
                    0 0 30px rgba(0, 255, 0, 0.3);
                transform: perspective(1000px) scaleY(1.2);
                cursor: url("./cursor.png"), auto;
                overflow-y: auto; /* Enable vertical scrolling */
                overflow-x: hidden; /* Disable horizontal scrolling */
            }

            body {
                background-color: black;
                color: #33ff33;
                font-family: "WebPlus_IBM_EGA_9x8", monospace;
                font-size: 80%;
                margin: 0;
                padding: 2rem;
                cursor: url("./cursor.png"), auto;
            }

            .terminal {
                white-space: pre-wrap;
                overflow-y: auto;
                border: 1px solid #33ff33;
                padding: 1rem;
                max-height: 60vh;
                margin-bottom: 1rem;
                white-space: pre-wrap;
            }

            button {
                display: block;
                margin: 0.5rem 0;
                background: black;
                color: #33ff33;
                border: 0px;
                padding: 0.5rem 1rem;
                font-family: "WebPlus_IBM_EGA_9x8", monospace;
                font-size: 100%;
                cursor: url("./cursor_inverted.png"), auto;
            }

            button:hover {
                background: #33ff33;
                color: black;
                box-shadow:
                    0 0 5px #33ff33,
                    0 0 10px #33ff33,
                    0 0 20px #33ff33;
                text-shadow:
                    0 0 5px #000000,
                    0 0 10px #000000;
                cursor: url("./cursor_inverted.png"), auto;
            }

            .glow {
                text-shadow:
                    0 0 5px #33ff33,
                    0 0 10px #33ff33;
            }

            #apiKeyInput {
                width: 100%;
                padding: 0.5rem;
                margin-bottom: 1rem;
                background: black;
                color: #33ff33;
                border: 1px solid #33ff33;
                font-family: "WebPlus_IBM_EGA_9x8", monospace;
                font-size: 100%;
                box-sizing: border-box;
                cursor: url("./cursor.png"), auto;
            }

            #apiKeyInput:focus {
                outline: none;
                box-shadow:
                    0 0 5px #33ff33,
                    0 0 10px #33ff33;
            }

            #apiKeyInput::placeholder {
                color: #66ff66; /* Faint green placeholder */
                opacity: 0.6; /* Slightly transparent for that ghostly CRT feel */
                font-family: "WebPlus_IBM_EGA_9x8", monospace;
            }
        </style>

        <script type="module">
            // THIS IS A VIBE CODING SESSION, TO SEE WHAT YOU CAN DO WITH AI
            // THINGS LOOK AWFUL, TERRIBLE LOOKING CODE BY CHATGPT 4.0
            import OpenAI from "https://cdn.skypack.dev/openai";

            let client = null;
            let currentMove = 1;
            let currentScene = "";

            const MAX_MOVES = 10;
            const terminal = document.getElementById("terminal");
            const choicesContainer = document.getElementById("choices");

            const systemPrompt = {
                role: "system",
                content: `You are a retro-futuristic interactive story engine set in an 80s horror vibe. Where protagonist is the reader and the AI will eventually decide the fate of the protagonist.

                                      STORY RULES:
                                      - The story is set in 1984, the reader, will be the protagonists in this classic horror story, where sex, drugs, violence and inevitable death will occur, this is 18+ so DO NOT HOLD BACK.
                                      - The player MUST BE THE protagonist.
                                      - The AI decides the fate of the protagonist and eventually in the last move the the AI decides of the reader survives or not.
                                      - Build from intrigue, mystery, romanticm tension (18+), NO HOLDING BACK WITH SEX, BLOOD AND GORE AND HORROR TROPES, when we get to ${MAX_MOVES * 0.75} the violence turns full on, nobody is potentially safe and after ${MAX_MOVES} moves we see if the reader survives or is the last one to be slaughtered.
                                      - Always return EXACTLY THREE numbered choices at the end:
                                        - Format each on its own line.
                                        - Begin with: 1. ... 2. ... 3. ...
                                        - Use consistent numbering with no prose.
                                        - Choices must be unique, actionable, and relevant to the scene.
                                        - Make sure the choices progress the story in varied and interesting directions.
                                        - Always provide **three distinct** and **unique options** for each scene.
                                        - The player will NOT DIE before the ${MAX_MOVES}
                                        - The horror builds up slowly, creating tension and suspense.
                                      - Always have the story say "you" instead of the player, to make it seem the player is the protagonist.
                                      - Do NOT repeat the same action more than once.
                                      - The AI writes in the style of Stephen King and Dean Koontz.
                                      - Every choice must be a consequence of the previous choices.
                                      - Some paths can reach to gore and violence faster than others, but the STORY NEVER exceed ${MAX_MOVES} moves.
                                      - Do not include commentary. Only return story + 3 numbered options.
                                      - Ensure the choices are **distinct and meaningful**, driving the story forward in interesting, varied directions.
                                      - Do not make the same choices repeatedly — each scene must offer new ways to progress.
                                      - The violence can be reached sooner than ${MAX_MOVES}, depending on the intensity and pace of the choices. Encourage faster progression when intimacy builds quickly.
                                      - The AI can flesh out the ending giving an explanation who the killer (which can be a person or an entity) is and why they did it: "*** The End."`,
            };

            const messages = [systemPrompt];
            const CHOICE_PROMPT = `You have ${MAX_MOVES} moves to reach and the AI will determine if the reader is killed in the last move or barely gets away. This is move 1.
                      Provide three typical horror reopw choices to proceed, numbered 1 to 3, each on its own line.
                      Progressively making the choices more dangerous and more violent and daring!`;

            const scenes = {
                slaughter_house: {
                    prompt: `A deary, dilapidated slaughterhouse in the middle of nowhere. Where the group including the reader are standing in front of the slaughterhouse where a blood stained sign reveals the name of the company: <AI makes up a very horrific suggestive name here>.
                                          Begin the mystery and by inviting them inside. Describe the scene and let them explore and be picked up by the killer one by one and killed in a gruesome manner.
                                         ${CHOICE_PROMPT}`,
                },
                town_house: {
                    prompt: `An old townhouse in the middle of a street. Where the group of teenagers are standing in front of the townhouse that is named by the kids in the neighborhood: <AI makes up a very horrific suggestive name here> where some horrific things are happening have happened <which the AI can dream up>.
                                          Begin the mystery. As the story progresses people will get tortured and killed in a gruesome manner.
                                          ${CHOICE_PROMPT}`,
                },
                grave_yard: {
                    prompt: `An old graveyard in an old village where the reader and his family and friends get somehow stranded <the AI can make up how the got stranded> has some made some very weird-, horrific- and eerie victims. <AI makes up the name of the graveyard>. In this graveyard people who come in alive somehow very often end up dead as to how and why the <which the AI can dream up>.
                                          Begin the mystery. As the story progresses people will get tortured and killed in a gruesome manner.
                                          ${CHOICE_PROMPT}`,
                },
                hitchhiker: {
                    prompt: `The reader picks up a hitchhiker named <AI creates the name of the hitchhiker> and they begin their journey together. However the hitchhiker is a serial killer and people on their way are killed and tortured in a horrific way. Will the reader survive or also end up dead? That is for the AI to decide.
                                          Begin the mystery. As the story progresses people will get tortured and killed in a gruesome manner, no matter what the reader does he will see the horror. Get inspired from The Movie The Hitcher, The Movie DUEL,Stephen King's The Hitchhiker.
                                          ${CHOICE_PROMPT}`,
                },
                boarding_school: {
                    prompt: `The reader is a teenager <AI creates a random age between 11 and 16> in a luxury boarding school. In that boarding school, children seem to go missing or tell stories about sexual abuse, torture and ritualistic killings. The parents don't seem to care. Will the reader try to escape or stay? Will reader survive or die? That is up to the AI to decide.
                                          Begin the mystery. As the story progresses people will get tortured and killed in a gruesome manner, no matter what the reader does he will see the horror.
                                          ${CHOICE_PROMPT}`,
                },
                mental_asylum: {
                    prompt: `<AI decideds if the reader is either a patient, a visitor or an employee> in this mental aslym. A mental asylm where very sinister things have (or still do happen) to the patients. Create a story about an asylum where terrible things happen. You can for example get inspiration from Silent Hill, Shutter Island and the likes. It ca be paranormal or psychological horror, the AI decides.
                                      Begin the mystery. And expose the reader gradually to the horror that have occured in the asylum and WILL DEFINITELY HAPPEN TO THE READER! Don't hold back in gore!
                                      ${CHOICE_PROMPT}`,
                },
                abandoned_carnival: {
                    prompt: `An abandoned carnival on the outskirts of town, rumored to have shut down after a mass disappearance of visitors decades ago. The reader and their group find the rusted gates unlocked. A crooked, faded sign reads: <AI invents a terrifying carnival name, like “Grinner’s Hollow” or “The Laughing Dark”>.
                                      Begin the mystery. The group enters and soon realizes they're not alone. Sinister clowns, grotesque rides, and haunted attractions become death traps.
                                      ${CHOICE_PROMPT}`,
                },

                deep_wood_cabin: {
                    prompt: `A remote log cabin in the middle of a dark, endless forest. The group, including the reader, seeks shelter after their car breaks down. Carved into the door are strange symbols and a phrase: <AI makes up a cursed warning>.
                                      Inside, things are wrong. Time loops, shadows move, and something ancient awakens in the trees.
                                      Begin the mystery. As the story progresses, characters will descend into madness, die in brutal ways, or vanish entirely.
                                      ${CHOICE_PROMPT}`,
                },

                sunken_hotel: {
                    prompt: `The reader and their companions descend into a partially flooded luxury hotel abandoned after a mass drowning incident. The hotel’s name <AI invents a twisted name, like “The Stillwater Estate”> still glows faintly above the algae-covered awning.
                                      Begin the mystery. Something lurks in the stagnant water, dragging people under. Ghostly guests roam the halls, repeating their final moments.
                                      ${CHOICE_PROMPT}`,
                },

                the_curse: {
                    prompt: `<AI decides how the reader gets cursed by someone or something> The curse is real and powerful. The reader must face it head-on. The AI decides how the curse manifests itself and whether the reader beats the curse or not.
                                        Begin the mystery.Very mundane, take inspiration from classic horror stories like Thinner, The Gypse, The Curse of the Mummy etc.
                                        ${CHOICE_PROMPT}`,
                },

                abandoned_mine: {
                    prompt: `The reader and friends some how <AI decides how> get to an abandoned mine said to be cursed after a collapse that buried dozens alive. The entrance is sealed with rusted chains and a warning scrawled in blood-red paint: <AI creates a horrific name or phrase>.
                                      Begin the mystery. As they go deeper underground, they begin hearing voices, seeing flickers of movement, and then one by one… they disappear.
                                      ${CHOICE_PROMPT}`,
                },

                lost_hospital: {
                    prompt: `The reader stumbles across a forgotten, overgrown hospital. Its name, <AI creates a disturbing hospital name>, is partially obscured by ivy. Inside, everything is preserved—beds unmade, charts still on clipboards, blood stains long dried.
                                      Begin the mystery. As the reader explores, echoes of past surgeries and long-dead patients return in horrific, physical form.
                                      ${CHOICE_PROMPT}`,
                },
                abandoned_church: {
                    prompt: `An old, crumbling church deep in a forest that doesn’t appear on any map. The reader and their companions discover it during a camping trip. Over the door, a carved phrase reads: <AI generates a blasphemous or foreboding church name or motto>.
                                      Inside, the altar is stained, the pews are shattered, and something unseen watches from the rafters.
                                      Begin the mystery. As the group explores, they encounter increasingly unholy horrors — some human, some not. Sacrifices will be made.
                                      ${CHOICE_PROMPT}`,
                },

                sunken_ship: {
                    prompt: `The reader joins a deep-sea salvage crew to explore a recently discovered sunken vessel named <AI creates an eerie ship name>. The ship rests in an unnatural trench where no life should exist.
                                      As the team dives and enters the hull, things begin to move in the shadows. Old crew logs speak of madness, rituals, and “something awakened in the deep.”
                                      Begin the mystery. One by one, the divers vanish or turn on each other in horrifying ways. The sea does not give back what it takes.
                                      ${CHOICE_PROMPT}`,
                },

                desert_motel: {
                    prompt: `A dusty motel off a forgotten desert highway. As the reader and optionally <AI gets cho choose whether the reader is alone or with a partner or a whole famile> check in for the night. Things are not right, you won't catch sleep as this place can house ghosts, serial killers, and other horrors.
                                      <AI invents the motel’s name — something suggestive of decay or death>.
                                      Begin the mystery. The other guests may not be human. Time is strange here. Violence seeps into the walls.
                                      ${CHOICE_PROMPT}`,
                },

                alien_forest: {
                    prompt: `A research team, including the reader, lands on an uncharted planet covered in thick, bioluminescent jungle. The trees whisper. The sky shifts colors. A trail of missing expedition members leads to a pulsing structure of unknown origin.
                                      <AI names the alien forest with something ancient and unpronounceable>.
                                      Begin the mystery. As the team explores, their minds begin to warp, and the forest seems to breathe. What’s killing them may already be inside them.
                                      ${CHOICE_PROMPT}`,
                },

                mirror_house: {
                    prompt: `The reader wakes up inside a grand Victorian house made entirely of mirrors. No memory of how they got there. Their reflection is slightly... off. Other “versions” of themselves appear in different mirrors. One begins to move without the reader.
                                      <AI gives the house a name that hints at fractured reality or forbidden reflection>.
                                      Begin the mystery. Every room is a psychological trap. And the reflections want out.
                                      ${CHOICE_PROMPT}`,
                },
                trick_or_treat: {
                    prompt: `The reader is an early teenager, who goes trick or treating <AI decides whether he is alone or accompanied by friends>. <The AI decides whether they can become kidnapped and horribly tortured and abused. They are murdered by one by one by a paranormal entity. Or slashed one by one by some serial killer. Get inspired by stores like Trick Or Treat, Halloween Horror Nights, Halloween. Nobody is safe! NOT EVEN LITTLE KIDS!!! Sometimes reality is worse that paranormal stuff, so choose wisely dear AI!
                                      Begin the mystery, think of the most terrifying scenarios that could happen to the reader when it concerns your kids (razor blades in apples, drugs in apples that lead them to be kidnapped... Kids are not spared! If the reader survies this ordeal is up to the AI to decide!
                                      ${CHOICE_PROMPT}`,
                },
                dysfunctional_family: {
                    prompt: `The reader is a member of a dysfunctional family. They take you in torturing, raping and gaslighting complete strangers, nobody is safe from you and your family! Not even your own family members, because there are secrets of horrible deeds even among the family members. Incestious relationships are common in this family. Psychopathy is given in all the family members.
                    THINK SAW, Devils Rejects, TORTURE PORN HORROR GENRE!
                    Begin the mystery with the reader being the biggest psychopath in the family, taking any chance to hurt and kill anyone young or old give the chance.
                    ${CHOICE_PROMPT}`,
                },
                serial_killer_style: {
                    prompt: `THE READER IS THE ANTAGONIST, A MIDDLE AGED SERIAL KILLER. He targets exclusive male high school students.
                    The antagonist is good looking and charming. He already killed several high school students and the cops have no clue. <THE AI DECIDES AD RANDOM, IF THIS VICTIM WILL TURN THE TABLES ON HIM OR NOT>
                    IMPORTANT, NO CREATURES, NO PARANORMAL ELEMENTS, NO MAGIC, NO SUPERNATURAL ELEMENTS, NO OTHER WORLD ELEMENTS!
                    ${CHOICE_PROMPT}`,
                },
                home_invasion_teen_victim: {
                    prompt: `The reader is a teenager <AI comes up with a name> he becomes the victim of a house invasion. <AI decides if he is alone or with his friends or siblings>. The reader and the optional siblings or friends are confronted by <the AI decides it it's a group of psychopaths or a single psychopath>.
                    The main antagonist is has a twisted sense of humor and enjoys torturing his victims. The victim is terrified and has no idea what to do.
                    He stops at nothing! Young or old, he will kill them all! <THE AI DECIDES AD RANDOM, IF THE PROTAGONIST WILL TURN THE TABLES ON HIM OR NOT>
                    IMPORTANT, NO CREATURES, NO PARANORMAL ELEMENTS, NO MAGIC, NO SUPERNATURAL ELEMENTS, NO OTHER WORLD ELEMENTS!
                    Please take inspiration from the following prompt: Movies like SCREAM, The Babysitter, Summer of 84, Intrusion, I See You etc.
                    So lots of blood and gore and suspense.
                    ${CHOICE_PROMPT}`,
                },
            };

            function showSceneMenu() {
                const sceneButtons = document.getElementById("sceneButtons");
                sceneButtons.innerHTML = ""; // clear old

                for (let key in scenes) {
                    if (!key.startsWith("scene_")) {
                        const btn = document.createElement("button");
                        btn.textContent = key;
                        btn.onclick = () => startSelectedScene(key);
                        sceneButtons.appendChild(btn);
                    }
                }
            }

            function startSelectedScene(sceneKey) {
                document.getElementById("sceneMenu").style.display = "none";
                document.getElementById("terminal").style.display = "block";
                document.getElementById("choices").style.display = "block";
                document.getElementById("header").style.display = "block";

                currentMove = 1;
                currentScene = sceneKey;
                getScene(sceneKey);
            }

            window.startRandomScene = function () {
                const keys = Object.keys(scenes).filter(
                    (k) => !k.startsWith("scene_"),
                );
                const randomKey = keys[Math.floor(Math.random() * keys.length)];
                console.log(randomKey);
                startSelectedScene(randomKey);
            };

            window.updateApiKey = function () {
                const input = document.getElementById("apiKeyInput");
                var apiKey = input.value;
                console.log("API Key updated:", apiKey); // Optional debug output
                client = new OpenAI({
                    apiKey,
                    dangerouslyAllowBrowser: true,
                });
                console.log("Client initialized:", client);
            };

            function wrapText(text, maxWidth = 80) {
                const words = text.split(/\s+/);
                let line = "";
                let result = "";
                for (let word of words) {
                    if ((line + word).length > maxWidth) {
                        result += line.trim() + "\n";
                        line = "";
                    }
                    line += word + " ";
                }
                return result + line.trim();
            }

            function parseOptions(text) {
                const lines = text.split("\n").map((line) => line.trim());
                const options = [];
                for (let line of lines) {
                    const match = line.match(/^(\d)[\.\)]\s+(.*)/);
                    if (match) options.push(match[2]);
                }
                // If not enough parsed, return empty to trigger manual input
                return options.length >= 3 ? options.slice(0, 3) : [];
            }

            async function getScene(sceneKey, userChoice = null) {
                const newMessages = [...messages];

                if (userChoice) {
                    newMessages.push({
                        role: "user",
                        content: `You previously chose: "${userChoice}"`,
                    });
                } else {
                    newMessages.push({
                        role: "user",
                        content: scenes[sceneKey].prompt,
                    });
                }

                // Clear screen before new output
                terminal.textContent = "Writing the next horrific paragraph...";
                choicesContainer.innerHTML = "";

                const response = await client.chat.completions.create({
                    model: "gpt-4.1",
                    messages: newMessages,
                });

                const storyText = response.choices[0].message.content.trim();
                const wrapped = wrapText(storyText).replace(/1\..*$/s, "");
                terminal.textContent = wrapped;

                messages.push({ role: "assistant", content: storyText });

                const options = parseOptions(storyText);
                renderChoices(options);
            }

            function renderChoices(options) {
                choicesContainer.innerHTML = ""; // Clear old buttons

                if (options.length === 0) {
                    const msg = document.createElement("div");
                    msg.className = "glow";
                    msg.textContent = "Let's hope this never happens again.";
                    choicesContainer.appendChild(msg);

                    return;
                }

                // Show the 3 parsed options
                options.forEach((opt, i) => {
                    const btn = document.createElement("button");
                    btn.textContent = `${i + 1}. ${opt}`;
                    btn.className = "glow";
                    btn.onclick = () => {
                        makeChoice(opt);
                    };
                    choicesContainer.appendChild(btn);
                });
            }

            let isProcessingChoice = false;

            async function makeChoice(choice) {
                if (isProcessingChoice) {
                    console.warn("Choice already in progress.");
                    return;
                }

                isProcessingChoice = true;

                console.log("makeChoice called with:", choice);
                console.log("currentMove BEFORE increment:", currentMove);

                const remaining = Math.max(MAX_MOVES - currentMove, 0);
                const key = `scene_${currentMove}`;

                scenes[key] = {
                    prompt: `You previously chose: "${choice}".\nThis is move ${currentMove} out of ${MAX_MOVES}. There are ${remaining} moves left before the climax must happen.\nNarrate the next phase in second person, continuing the tension, torture and horror. Raise the stakes, advance the violence and death.\nIf this is the final move (${currentMove} == ${MAX_MOVES}), teh AI must decide whether the reader gets away (can be extremely hurt) or is slaughtered in the a horrific painful way and then write: "*** The End."\nOtherwise, follow with exactly three unique, story-progressing, progressing, daring, stupid or dangerous choices.`,
                };

                currentScene = key;
                console.log(currentScene);
                await getScene(currentScene, choice);

                currentMove++;
                isProcessingChoice = false;
            }

            // Start the story
            window.onload = () => {
                document.getElementById("header").style.display = "none";
                document.getElementById("terminal").style.display = "none";
                document.getElementById("choices").style.display = "none";

                showSceneMenu();
            };
        </script>
    </head>

    <body>
        <div id="crt">
            <div id="sceneMenu" class="glow">
                <h2>Select a Scene</h2>
                <!-- API Key Input -->
                <label for="apiKeyInput">OpenAI API Key:</label>
                <input
                    type="text"
                    id="apiKeyInput"
                    placeholder="Enter API key"
                    oninput="updateApiKey()"
                />

                <div id="sceneButtons"></div>
                <button onclick="startRandomScene()">Random Scene</button>
            </div>
            <div id="header" class="glow">
                SOMNIATRIX HORROR NIGHTMARE TERMINAL
            </div>
            <div id="terminal" class="terminal glow">
                Connecting to story engine...
            </div>
            <div id="choices"></div>
        </div>
    </body>
</html>
