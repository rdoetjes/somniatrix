<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Somniatrix Erotic Dream Terminal</title>
        <style>
            @font-face {
                font-family: "WebPlus_IBM_EGA_9x8";
                src: url("./WebPlus_IBM_EGA_9x8.woff") format("woff");
                font-weight: normal;
                font-style: normal;
                line-height: 20px; /* or 18px for 2px spacing */
            }

            #crt {
                width: 80vw; /* 80% of the viewport width */
                height: 73vh; /* 90% of the viewport height */
                margin: 5vh auto; /* 5% vertical margin (5% top and bottom) */
                padding: 30px;
                background: radial-gradient(
                    ellipse at center,
                    rgba(0, 0, 0, 0) 50%,
                    rgba(0, 0, 0, 0.25) 100%
                );
                color: #33ff33;
                font-family: "WebPlus_IBM_EGA_9x8", monospace;
                font-size: 10px;
                line-height: 18px;
                border-radius: 30px;
                box-shadow:
                    inset 0 0 40px rgba(0, 255, 0, 0.2),
                    0 0 30px rgba(0, 255, 0, 0.3);
                transform: perspective(1000px) scaleY(1.2);
                cursor: url("./cursor.png"), auto;
                overflow-y: auto; /* Enable vertical scrolling */
                overflow-x: hidden; /* Disable horizontal scrolling */
            }

            body {
                background-color: black;
                color: #33ff33;
                font-family: "WebPlus_IBM_EGA_9x8", monospace;
                font-size: 80%;
                margin: 0;
                padding: 2rem;
                cursor: url("./cursor.png"), auto;
            }

            .terminal {
                white-space: pre-wrap;
                overflow-y: auto;
                border: 1px solid #33ff33;
                padding: 1rem;
                max-height: 60vh;
                margin-bottom: 1rem;
                white-space: pre-wrap;
            }

            button {
                display: block;
                margin: 0.5rem 0;
                background: black;
                color: #33ff33;
                border: 0px;
                padding: 0.5rem 1rem;
                font-family: "WebPlus_IBM_EGA_9x8", monospace;
                font-size: 100%;
                cursor: url("./cursor_inverted.png"), auto;
            }

            .glow {
                text-shadow:
                    0 0 5px #33ff33,
                    0 0 10px #33ff33;
            }
        </style>

        <script type="module">
            // THIS IS A VIBE CODING SESSION, TO SEE WHAT YOU CAN DO WITH AI
            // THINGS LOOK AWFUL, TERRIBLE LOOKING CODE BY CHATGPT 4.0
            import OpenAI from "https://cdn.skypack.dev/openai";

            const apiKey = "YOUR_API_KEY"; // use your real key here
            const client = new OpenAI({
                apiKey,
                dangerouslyAllowBrowser: true,
            });

            const MAX_MOVES = 10;
            let currentMove = 1;
            let currentScene = "clubEntrance";

            const terminal = document.getElementById("terminal");
            const choicesContainer = document.getElementById("choices");

            const systemPrompt = {
                role: "system",
                content: `You are a retro-futuristic interactive story engine set in a sensual, mystical, synthwave 80s world.

                STORY RULES:
                - The story is set in 1984, neon-lit, where cocaine is cheap and people crave sex.
                - The protagonist must be a man.
                - He will need to find a woman in the club.
                - Build from intrigue, mystery, romantic tension (18+) into sexually very explicit, NO HOLDING BACK, when we get to ${MAX_MOVES * 0.075} and slowly evolve into a more and more sexually explicit story over the ${MAX_MOVES} moves.
                - Eventually, the woman consents to have hardcore sex with the protagonist, and then the story ends.
                - Always return EXACTLY THREE numbered choices at the end:
                  - Format each on its own line.
                  - Begin with: 1. ... 2. ... 3. ...
                  - Use consistent numbering with no prose.
                  - Choices must be unique, actionable, and relevant to the scene.
                  - Make sure the choices progress the story in varied and interesting directions.
                  - Always provide **three distinct** and **unique options** for each scene.
                  - The player will NOT CUM or CLIMAX
                  - The lady must reach the climax by ${MAX_MOVES} moves or fewer.
                - Always have the story say "you" instead of the player, to make it seem the player is the protagonist.
                - Do NOT repeat the same action more than once.
                - Every choice must be a consequence of the previous choices.
                - Some paths can reach climax faster than others, but NEVER exceed ${MAX_MOVES} moves.
                - Do not include commentary. Only return story + 3 numbered options.
                - Ensure the choices are **distinct and meaningful**, driving the story forward in interesting, varied directions.
                - Do not make the same choices repeatedly â€” each scene must offer new ways to progress.
                - The climax can be reached sooner than ${MAX_MOVES}, depending on the intensity and pace of the choices. Encourage faster progression when intimacy builds quickly.
                - When climax is reached, the AI will say how you came inside of her she will praise you for the big load you gave her. The AI can flesh out the ending: "\ud83d\udd25 The End."`,
            };

            const messages = [systemPrompt];

            const scenes = {
                clubEntrance: {
                    prompt: `A synth-drenched, sleazy MIAMI neighborhood. You stand before a pulsing neon club called <AI makes up a very sexually suggestive name here> It hums like it knows your name.
                    Begin the mystery and seduction. Describe the scene and mention the club's name.
                    You have ${MAX_MOVES} moves to reach the climax we get very sexually explicit. This is move 1.
                    Provide three seductive choices to proceed, numbered 1 to 3, each on its own line.
                    Progressively making the choices more seductive and intimate and daring!`,
                },
            };

            function wrapText(text, maxWidth = 80) {
                const words = text.split(/\s+/);
                let line = "";
                let result = "";
                for (let word of words) {
                    if ((line + word).length > maxWidth) {
                        result += line.trim() + "\n";
                        line = "";
                    }
                    line += word + " ";
                }
                return result + line.trim();
            }

            function parseOptions(text) {
                const lines = text.split("\n").map((line) => line.trim());
                const options = [];
                for (let line of lines) {
                    const match = line.match(/^(\d)[\.\)]\s+(.*)/);
                    if (match) options.push(match[2]);
                }
                // If not enough parsed, return empty to trigger manual input
                return options.length >= 3 ? options.slice(0, 3) : [];
            }

            async function getScene(sceneKey, userChoice = null) {
                const newMessages = [...messages];

                if (userChoice) {
                    newMessages.push({
                        role: "user",
                        content: `You previously chose: "${userChoice}"`,
                    });
                } else {
                    newMessages.push({
                        role: "user",
                        content: scenes[sceneKey].prompt,
                    });
                }

                // Clear screen before new output
                terminal.textContent = "Writing the next sexy paragraph...";
                choicesContainer.innerHTML = "";

                const response = await client.chat.completions.create({
                    model: "gpt-4.1",
                    messages: newMessages,
                });

                const storyText = response.choices[0].message.content.trim();
                const wrapped = wrapText(storyText).replace(/1\..*$/s, "");
                terminal.textContent = wrapped;

                messages.push({ role: "assistant", content: storyText });

                const options = parseOptions(storyText);
                renderChoices(options);
            }

            function renderChoices(options) {
                choicesContainer.innerHTML = ""; // Clear old buttons

                if (options.length === 0) {
                    const msg = document.createElement("div");
                    msg.className = "glow";
                    msg.textContent =
                        "We recorded you with your webcam whilst reading this!!! You are nasty!!!";
                    choicesContainer.appendChild(msg);

                    return;
                }

                // Show the 3 parsed options
                options.forEach((opt, i) => {
                    const btn = document.createElement("button");
                    btn.textContent = `${i + 1}. ${opt}`;
                    btn.className = "glow";
                    btn.onclick = () => {
                        makeChoice(opt);
                    };
                    choicesContainer.appendChild(btn);
                });
            }

            let isProcessingChoice = false;

            async function makeChoice(choice) {
                if (isProcessingChoice) {
                    console.warn("Choice already in progress.");
                    return;
                }

                isProcessingChoice = true;

                console.log("makeChoice called with:", choice);
                console.log("currentMove BEFORE increment:", currentMove);

                const remaining = Math.max(MAX_MOVES - currentMove, 0);
                const key = `scene_${currentMove}`;

                scenes[key] = {
                    prompt: `You previously chose: "${choice}".\nThis is move ${currentMove} out of ${MAX_MOVES}. There are ${remaining} moves left before climax must happen.\nNarrate the next phase in second person, continuing the seduction or sexual tension. Raise the stakes, advance the intimacy.\nIf this is the final move (${currentMove} == ${MAX_MOVES}), she must climax the story by saying: "Yes, take me hard!" and then write: "ðŸ”¥ The End."\nOtherwise, follow with exactly three unique, story-progressing, flirty, or bold choices.`,
                };

                currentScene = key;

                await getScene(key, choice);

                currentMove++;
                isProcessingChoice = false;
            }

            // Start the story
            window.onload = () => {
                currentMove = 1;
                getScene("clubEntrance");
            };
        </script>
    </head>

    <body>
        <div id="crt">
            <div id="header" class="glow">
                â™¥SOMNIATRIX EROTIC DREAM TERMINALâ™¥
            </div>
            <div id="terminal" class="terminal glow">
                Connecting to story engine...
            </div>
            <div id="choices"></div>
        </div>
    </body>
</html>
